---
- hosts: vagrant
  gather_facts: no
  user: vagrant
  vars:
    color: brown
    gac_dir: /vol/fou/sicci1/data/gacrepr1/pps_v1
    local_gac_dir: /disk1/gac-data
    # project_dir: /disk1/workspace/ice-arc
    project_dir: ~/ice-arc
    venv: "{{ project_dir }}/codeshop/icearc-avhrr-sic/venv-vagrant"

  tasks:

  - name: Install virtualenv
    apt: name={{ item }} state=present update_cache=yes
    sudo: true
    sudo_user: root
    with_items:
      - git
      - python-dev
      - libhdf5-serial-dev
      - sshfs
    tags:
      - apt

  - name: Create project directory
    file: path={{ project_dir }} state=directory

  - name: Update pip
    pip: virtualenv={{ venv }} name={{ item }} extra_args='--upgrade'
    with_items:
      - pip
      - behave
      - PyYAML

  - name: Install pypps_reader
    pip: name='git+https://github.com/mitkin/pypps_reader.git#egg=pypps_reader'
         virtualenv={{ venv }}

  - name: Get ICE ARC code from git
    git: repo=git@gitlab.met.no:istjenesten/icearc-avhrr-sic.git
         dest=~/icearc-avhrr-sic
         accept_hostkey=yes
         force=yes key_file="{{ lookup('file', '/home/mikhaili/.ssh/metno.pub') }}"
         version=behave-deploy
    tags:
      - git

  - name: Run behaviour tests
    shell: "{{ venv }}/bin/behave"
    args:
      chdir: ~/icearc-avhrr-sic
    tags:
      - tests

  - name: Make a mount point
    file: path={{ local_gac_dir }} state=directory
    sudo: yes
    tags:
      - ssh

  - name: Mount data directory
    shell: sshfs "mikhaili@10.0.2.2:{{ gac_dir }}" {{ local_gac_dir }}
    tags:
      - ssh
